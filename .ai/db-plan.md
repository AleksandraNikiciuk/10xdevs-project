## Database Schema for 10x-cards

This document outlines the database schema for the 10x-cards application, designed for PostgreSQL and managed via Supabase.

### 1. Tables

#### `users`

This table is manage by Supabase Auth.

- id: UUID PRIMARY KEY
- email: VARCHAR(255) NOT NULL UNIQUE
- encrypted_password: VARCHAR NOT NULL
- created_at: TIMESTAMPTZ NOT NULL DEFAULT now()
- confirmed_at: TIMESTAMPTZ

#### `generations`

Stores metadata about each flashcard generation session.

| Column                    | Data Type     | Constraints                                  | Description                                          |
| ------------------------- | ------------- | -------------------------------------------- | ---------------------------------------------------- |
| `id`                      | `bigserial`   | `PRIMARY KEY`                                | Unique identifier for the generation.                |
| `user_id`                 | `uuid`        | `NOT NULL`, `FOREIGN KEY (users.id)`         | References the user who initiated the generation.    |
| `model`                   | `varchar`     | `NOT NULL`                                   | The model used for the generation.                   |
| `source_text_length`      | `integer`     | `NOT NULL`, `CHECK (source_text_length > 0)` | Length of the source text used for generation.       |
| `source_text_hash`        | `varchar`     | `NOT NULL`                                   | Hash of the source text to identify duplicates.      |
| `generated_count`         | `integer`     | `NOT NULL`, `DEFAULT 0`                      | Number of flashcards generated in the session.       |
| `accepted_unedited_count` | `integer`     | `NOT NULL`, `DEFAULT 0`                      | Number of accepted flashcards without edits.         |
| `accepted_edited_count`   | `integer`     | `NOT NULL`, `DEFAULT 0`                      | Number of accepted flashcards with edits.            |
| `generation_duration`     | `integer`     | `NOT NULL`                                   | Duration of the generation process in seconds.       |
| `created_at`              | `timestamptz` | `NOT NULL`, `DEFAULT now()`                  | Timestamp of when the generation was created.        |
| `updated_at`              | `timestamptz` | `NOT NULL`, `DEFAULT now()`                  | Timestamp of the last update (managed by a trigger). |

#### `flashcards`

Contains individual flashcards, either generated by AI or created manually.

| Column          | Data Type       | Constraints                                                        | Description                                          |
| --------------- | --------------- | ------------------------------------------------------------------ | ---------------------------------------------------- |
| `id`            | `bigserial`     | `PRIMARY KEY`                                                      | Unique identifier for the flashcard.                 |
| `user_id`       | `uuid`          | `NOT NULL`, `FOREIGN KEY (users.id)`                               | Denormalized reference to the user for easy queries. |
| `generation_id` | `bigint`        | `FOREIGN KEY (generations.id) ON DELETE SET NULL`                  | References the generation session if created by AI.  |
| `question`      | `varchar(255)`  | `NOT NULL`                                                         | The front side of the flashcard.                     |
| `answer`        | `varchar(1000)` | `NOT NULL`                                                         | The back side of the flashcard.                      |
| `source`        | `varchar(50)`   | `NOT NULL`, `CHECK (source IN ('ai-full', 'ai-edited', 'manual'))` | Indicates how the flashcard was created.             |
| `created_at`    | `timestamptz`   | `NOT NULL`, `DEFAULT now()`                                        | Timestamp of when the flashcard was created.         |
| `updated_at`    | `timestamptz`   | `NOT NULL`, `DEFAULT now()`                                        | Timestamp of the last update (managed by a trigger). |

#### `generation_error_logs`

Logs errors that occur during the flashcard generation process.

| Column               | Data Type      | Constraints                          | Description                                        |
| -------------------- | -------------- | ------------------------------------ | -------------------------------------------------- |
| `id`                 | `bigserial`    | `PRIMARY KEY`                        | Unique identifier for the error log.               |
| `user_id`            | `uuid`         | `NOT NULL`, `FOREIGN KEY (users.id)` | References the user who encountered the error.     |
| `error_code`         | `varchar(100)` | `NOT NULL`                           | A specific code for the type of error.             |
| `error_message`      | `text`         | `NOT NULL`                           | The detailed error message.                        |
| `model`              | `varchar`      | `NOT NULL`                           | The model used when the error occurred.            |
| `source_text_length` | `integer`      | `NOT NULL`                           | Length of the source text when the error occurred. |
| `source_text_hash`   | `varchar`      | `NOT NULL`                           | Hash of the source text when the error occurred.   |
| `created_at`         | `timestamptz`  | `NOT NULL`, `DEFAULT now()`          | Timestamp of when the error occurred.              |

### 2. Relationships

- **`users` and `generations`**: One-to-Many. A user can have multiple generation sessions.
  - `generations.user_id` -> `auth.users.id` (`ON DELETE CASCADE`)
- **`users` and `flashcards`**: One-to-Many. A user can have multiple flashcards.
  - `flashcards.user_id` -> `auth.users.id` (`ON DELETE CASCADE`)
- **`generations` and `flashcards`**: One-to-Many. A generation session can produce multiple flashcards. A flashcard can optionally be linked to a generation.
  - `flashcards.generation_id` -> `generations.id` (`ON DELETE SET NULL`)
- **`users` and `generation_error_logs`**: One-to-Many. A user can have multiple error logs.
  - `generation_error_logs.user_id` -> `auth.users.id` (`ON DELETE CASCADE`)

### 3. Indexes

- `idx_generations_on_user_id`: on `generations(user_id)`
- `idx_flashcards_on_user_id`: on `flashcards(user_id)`
- `idx_flashcards_on_generation_id`: on `flashcards(generation_id)`
- `idx_generation_error_logs_on_user_id`: on `generation_error_logs(user_id)`

### 4. Row-Level Security (RLS) Policies

#### Zasady RLS (Row-Level Security)

W tabelach `flashcards`, `generations` oraz `generation_error_logs` należy wdrożyć polityki RLS, które pozwalają użytkownikowi na dostęp tylko do rekordów, gdzie `user_id` odpowiada identyfikatorowi użytkownika z Supabase Auth (np. `auth.uid() = user_id`).

- **`generations` table**:
  - **Policy**: `Enable RLS`
  - **`SELECT`, `INSERT`, `UPDATE`, `DELETE`**: `user_id = auth.uid()`
  - Użytkownik ma dostęp tylko do własnych sesji generowania fiszek
- **`flashcards` table**:
  - **Policy**: `Enable RLS`
  - **`SELECT`, `INSERT`, `UPDATE`, `DELETE`**: `user_id = auth.uid()`
  - Użytkownik ma dostęp tylko do własnych fiszek
- **`generation_error_logs` table**:
  - **Policy**: `Enable RLS`
  - **`SELECT`, `INSERT`, `UPDATE`, `DELETE`**: `user_id = auth.uid()`
  - Użytkownik ma dostęp tylko do własnych logów błędów

### 5. Additional Notes and Design Decisions

- **Trigger for `updated_at`**: A trigger will be created to automatically update the `updated_at` column in the `flashcards` table whenever a row is modified.

  ```sql
  CREATE OR REPLACE FUNCTION handle_updated_at()
  RETURNS TRIGGER AS $$
  BEGIN
    NEW.updated_at = now();
    RETURN NEW;
  END;
  $$ LANGUAGE plpgsql;

  CREATE TRIGGER on_flashcard_update
  BEFORE UPDATE ON flashcards
  FOR EACH ROW
  EXECUTE PROCEDURE handle_updated_at();
  ```

  A similar trigger should be created for the `generations` table.

- **Users Table**: The `users` table is managed by Supabase Auth. It is referenced via `auth.users`.
