---
import Layout from "../layouts/Layout.astro";
import { listFlashcards } from "../lib/services/flashcard.service";
import { DEFAULT_USER_ID, createSupabaseAdmin } from "../db/supabase.client";
import FlashcardsView from "../components/flashcards/FlashcardsView";
import type { FlashcardDTO } from "../types";

// Get user from middleware
const user = Astro.locals.user;
const isAuthenticated = !!user;

// Use admin client to bypass RLS (same as API endpoints)
const supabase = createSupabaseAdmin({
  SUPABASE_URL: import.meta.env.SUPABASE_URL,
  SUPABASE_KEY: import.meta.env.SUPABASE_KEY,
  SUPABASE_SERVICE_ROLE_KEY: import.meta.env.SUPABASE_SERVICE_ROLE_KEY,
});

// Use authenticated user's ID or DEFAULT_USER_ID
const userId = isAuthenticated ? user.id : DEFAULT_USER_ID;

let flashcards: FlashcardDTO[] = [];
let error: string | null = null;

let totalFlashcards = 0;

try {
  const result = await listFlashcards({
    query: { page: 1, limit: 20 },
    userId,
    supabase,
  });
  flashcards = result.data;
  totalFlashcards = result.pagination.total;
} catch (e) {
  error = "Failed to load flashcards.";
}
---

<Layout title="Your Flashcards">
  <main class="container mx-auto px-2 py-8">
    <FlashcardsView client:load flashcards={flashcards} error={error} totalCount={totalFlashcards} />
  </main>
</Layout>
