---
import Layout from "../layouts/Layout.astro";
import { listFlashcards } from "../lib/services/flashcard.service";
import { DEFAULT_USER_ID } from "../db/supabase.client";
import FlashcardsView from "../components/flashcards/FlashcardsView";
import type { FlashcardDTO } from "../types";

// Get user from middleware
const user = Astro.locals.user;
const isAuthenticated = !!user;

// Use supabase client from middleware (has session set for authenticated users)
const supabase = Astro.locals.supabase;

// Use authenticated user's ID or DEFAULT_USER_ID
const userId = isAuthenticated ? user.id : DEFAULT_USER_ID;

let flashcards: FlashcardDTO[] = [];
let error: string | null = null;

let totalFlashcards = 0;

try {
  const result = await listFlashcards({
    query: { page: 1, limit: 20 },
    userId,
    supabase,
  });
  flashcards = result.data;
  totalFlashcards = result.pagination.total;
} catch {
  error = "Failed to load flashcards.";
}
---

<Layout title="Your Flashcards">
  <main class="container mx-auto px-2 py-8">
    <FlashcardsView client:load flashcards={flashcards} error={error} totalCount={totalFlashcards} />
  </main>
</Layout>
