---
// This page handles the OAuth callback after email verification
// It extracts tokens from URL hash and sets them as cookies
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verifying...</title>
  </head>
  <body>
    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: system-ui;">
      <div style="text-align: center;">
        <h2>Verifying your email...</h2>
        <p>Please wait while we log you in.</p>
      </div>
    </div>

    <script>
      // Extract tokens from URL hash fragment
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);

      const accessToken = params.get('access_token');
      const refreshToken = params.get('refresh_token');
      const type = params.get('type');

      console.log('[CALLBACK] Hash params:', { hasAccessToken: !!accessToken, hasRefreshToken: !!refreshToken, type });

      if (accessToken && refreshToken) {
        // Send tokens to server to set cookies
        fetch('/api/auth/callback', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            access_token: accessToken,
            refresh_token: refreshToken,
          }),
        })
          .then((response) => {
            console.log('[CALLBACK] Server response status:', response.status);
            if (response.ok) {
              // Redirect to generate page
              window.location.href = '/generate';
            } else {
              return response.json().then((data) => {
                throw new Error(data.error || 'Failed to set session');
              });
            }
          })
          .catch((error) => {
            console.error('[CALLBACK] Error:', error);
            alert('Failed to verify email. Please try logging in manually.');
            window.location.href = '/login';
          });
      } else {
        console.error('[CALLBACK] Missing tokens in URL hash');
        alert('Invalid verification link. Please try again.');
        window.location.href = '/login';
      }
    </script>
  </body>
</html>
