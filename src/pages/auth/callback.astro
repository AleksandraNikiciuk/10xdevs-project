---
// Server-side OAuth callback handler
const url = new URL(Astro.request.url);

// Extract tokens from hash (Supabase sends them in hash)
// Since we can't access hash on server, we need client-side redirect
// But we can handle query params if they exist
const accessToken = url.searchParams.get("access_token");
const refreshToken = url.searchParams.get("refresh_token");

if (accessToken && refreshToken) {
  // Tokens in query params - handle server-side
  try {
    const { data: { user }, error } = await Astro.locals.supabase.auth.getUser(accessToken);

    if (!error && user) {
      const isProduction = url.protocol === "https:";

      const cookieOptions = {
        path: "/",
        httpOnly: true,
        secure: isProduction,
        sameSite: "lax" as const,
        maxAge: 60 * 60 * 24 * 7,
      };

      Astro.cookies.set("sb-access-token", accessToken, cookieOptions);
      Astro.cookies.set("sb-refresh-token", refreshToken, {
        ...cookieOptions,
        maxAge: 60 * 60 * 24 * 30,
      });

      // Redirect to dashboard
      return Astro.redirect("/generate");
    }
  } catch (e) {
    console.error("Callback error:", e);
  }
}

// If we get here, tokens are in hash fragment or something went wrong
// We need client-side handling
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verifying...</title>
  </head>
  <body>
    <script is:inline>
      /* eslint-disable */
      (function () {
        // Extract tokens from hash
        var hash = window.location.hash.substring(1);
        if (!hash) {
          window.location.href = "/login?error=invalid_link";
          return;
        }

        var params = new URLSearchParams(hash);
        var accessToken = params.get("access_token");
        var refreshToken = params.get("refresh_token");

        if (!accessToken || !refreshToken) {
          window.location.href = "/login?error=invalid_link";
          return;
        }

        // Send tokens to API for cookie setting
        fetch("/api/auth/callback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            access_token: accessToken,
            refresh_token: refreshToken,
          }),
        })
          .then(function (response) {
            if (response.ok) {
              // Redirect immediately
              window.location.href = "/generate";
            } else {
              window.location.href = "/login?error=verification_failed";
            }
          })
          .catch(function () {
            window.location.href = "/login?error=connection_failed";
          });
      })();
      /* eslint-enable */
    </script>
  </body>
</html>
