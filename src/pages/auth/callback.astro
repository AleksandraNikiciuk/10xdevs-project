---
// Server-side OAuth callback handler
const url = new URL(Astro.request.url);

// Extract tokens from hash (Supabase sends them in hash)
// Since we can't access hash on server, we need client-side redirect
// But we can handle query params if they exist
const accessToken = url.searchParams.get("access_token");
const refreshToken = url.searchParams.get("refresh_token");

if (accessToken && refreshToken) {
  // Tokens in query params - handle server-side
  try {
    const {
      data: { user },
      error,
    } = await Astro.locals.supabase.auth.getUser(accessToken);

    if (!error && user) {
      const isProduction = url.protocol === "https:";

      // Build cookie strings manually
      const buildCookieString = (name: string, value: string, maxAge: number) => {
        const parts = [`${name}=${value}`, `Path=/`, `Max-Age=${maxAge}`, `SameSite=Lax`];
        if (isProduction) {
          parts.push("Secure");
        }
        parts.push("HttpOnly");
        return parts.join("; ");
      };

      const accessCookie = buildCookieString("sb-access-token", accessToken, 60 * 60 * 24 * 7);
      const refreshCookie = buildCookieString("sb-refresh-token", refreshToken, 60 * 60 * 24 * 30);

      // Build headers with multiple Set-Cookie
      const headers = new Headers();
      headers.append("Location", "/generate");
      headers.append("Set-Cookie", accessCookie);
      headers.append("Set-Cookie", refreshCookie);

      return new Response(null, {
        status: 302,
        headers,
      });
    }
  } catch (e) {
    console.error("Callback error:", e);
  }
}

// If we get here, tokens are in hash fragment or something went wrong
// We need client-side handling
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verifying...</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, sans-serif;
      }
      #status {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #666;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div id="status">Verifying...</div>

    <script is:inline>
      /* eslint-disable */
      (function () {
        var status = document.getElementById("status");

        // Extract tokens from hash
        var hash = window.location.hash.substring(1);
        if (!hash) {
          status.textContent = "Invalid link";
          setTimeout(function () {
            window.location.href = "/login?error=invalid_link";
          }, 1000);
          return;
        }

        var params = new URLSearchParams(hash);
        var accessToken = params.get("access_token");
        var refreshToken = params.get("refresh_token");

        if (!accessToken || !refreshToken) {
          status.textContent = "Invalid tokens";
          setTimeout(function () {
            window.location.href = "/login?error=invalid_link";
          }, 1000);
          return;
        }

        // Send tokens to API for cookie setting
        fetch("/api/auth/callback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include", // Important: allow cookies to be set
          body: JSON.stringify({
            access_token: accessToken,
            refresh_token: refreshToken,
          }),
        })
          .then(function (response) {
            if (response.ok) {
              status.textContent = "Success! Redirecting...";
              // Wait longer to ensure cookies are set
              setTimeout(function () {
                window.location.href = "/generate";
              }, 1500);
            } else {
              status.textContent = "Verification failed";
              return response.json().then(function (data) {
                console.error("Callback error:", data);
                status.textContent = "Error: " + (data.error || "Unknown error");
                setTimeout(function () {
                  window.location.href = "/login?error=verification_failed";
                }, 3000);
              });
            }
          })
          .catch(function (error) {
            status.textContent = "Connection error";
            console.error("Fetch error:", error);
            setTimeout(function () {
              window.location.href = "/login?error=connection_failed";
            }, 1000);
          });
      })();
      /* eslint-enable */
    </script>
  </body>
</html>
