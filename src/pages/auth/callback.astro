---
// Server-side OAuth callback handler
const url = new URL(Astro.request.url);

// Try to handle server-side if tokens are in query params
const accessToken = url.searchParams.get("access_token");
const refreshToken = url.searchParams.get("refresh_token");
const next = url.searchParams.get("next");
const type = url.searchParams.get("type");

if (accessToken && refreshToken) {
  try {
    const {
      data: { user },
      error,
    } = await Astro.locals.supabase.auth.getUser(accessToken);

    if (!error && user) {
      const isProduction = url.protocol === "https:";

      const buildCookieString = (name: string, value: string, maxAge: number) => {
        const parts = [`${name}=${value}`, `Path=/`, `Max-Age=${maxAge}`, `SameSite=Lax`];
        if (isProduction) {
          parts.push("Secure");
        }
        parts.push("HttpOnly");
        return parts.join("; ");
      };

      const accessCookie = buildCookieString("sb-access-token", accessToken, 60 * 60 * 24 * 7);
      const refreshCookie = buildCookieString("sb-refresh-token", refreshToken, 60 * 60 * 24 * 30);

      // Determine redirect location based on 'next' parameter or 'type'
      let redirectLocation = "/generate";
      if (next) {
        redirectLocation = next;
      } else if (type === "recovery") {
        redirectLocation = "/reset-password";
      }

      const headers = new Headers();
      headers.append("Location", redirectLocation);
      headers.append("Set-Cookie", accessCookie);
      headers.append("Set-Cookie", refreshCookie);

      return new Response(null, {
        status: 302,
        headers,
      });
    }
  } catch (e) {
    console.error("Callback error:", e);
  }
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verifying...</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        background: #f5f5f5;
      }
      .loader {
        text-align: center;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      h2 {
        color: #333;
        margin: 0 0 10px 0;
      }
      p {
        color: #666;
        margin: 0;
      }
      .error {
        color: #d32f2f;
      }
    </style>
  </head>
  <body>
    <div class="loader">
      <div class="spinner"></div>
      <h2 id="title">Verifying your email...</h2>
      <p id="message">Please wait</p>
    </div>

    <script is:inline>
      /* eslint-disable */
      (function () {
        var title = document.getElementById("title");
        var message = document.getElementById("message");

        function showError(msg) {
          title.textContent = "Verification Failed";
          title.className = "error";
          message.textContent = msg;
          message.className = "error";
        }

        // Extract tokens OR errors from hash or query params BEFORE clearing URL
        var accessToken = null;
        var refreshToken = null;
        var error = null;
        var errorDescription = null;
        var next = null;
        var type = null;

        var hash = window.location.hash.substring(1);
        if (hash) {
          var hashParams = new URLSearchParams(hash);
          accessToken = hashParams.get("access_token");
          refreshToken = hashParams.get("refresh_token");
          error = hashParams.get("error");
          errorDescription = hashParams.get("error_description");
          next = hashParams.get("next");
          type = hashParams.get("type");
        }

        if (!accessToken || !refreshToken) {
          var search = window.location.search.substring(1);
          if (search) {
            var searchParams = new URLSearchParams(search);
            accessToken = searchParams.get("access_token");
            refreshToken = searchParams.get("refresh_token");
            if (!error) {
              error = searchParams.get("error");
              errorDescription = searchParams.get("error_description");
            }
            if (!next) {
              next = searchParams.get("next");
            }
            if (!type) {
              type = searchParams.get("type");
            }
          }
        }

        // Determine redirect location based on 'next' or 'type'
        var redirectLocation = "/generate";
        if (next) {
          redirectLocation = next;
        } else if (type === "recovery") {
          redirectLocation = "/reset-password";
        }

        // Log what we received for debugging
        console.log("[CALLBACK CLIENT] Received:", {
          hasAccessToken: !!accessToken,
          hasRefreshToken: !!refreshToken,
          hasError: !!error,
          error: error,
          errorDescription: errorDescription,
          next: next,
          type: type,
          redirectLocation: redirectLocation,
        });

        // NOW clear the URL to hide tokens/errors
        if (window.location.hash || window.location.search) {
          window.history.replaceState({}, document.title, window.location.pathname);
        }

        // Check for Supabase errors first
        if (error) {
          var errorMsg = errorDescription ? decodeURIComponent(errorDescription.replace(/\+/g, " ")) : error;
          if (error === "access_denied" && errorMsg.includes("expired")) {
            showError("Verification link has expired. Please request a new one.");
          } else {
            showError(errorMsg);
          }
          setTimeout(function () {
            window.location.href = "/resend-verification";
          }, 3000);
          return;
        }

        if (!accessToken || !refreshToken) {
          showError("Invalid verification link. Please try again.");
          setTimeout(function () {
            window.location.href = "/login";
          }, 3000);
          return;
        }

        // Update title based on type
        if (type === "recovery") {
          title.textContent = "Verifying password reset...";
        }

        // Send tokens to API
        fetch("/api/auth/callback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({
            access_token: accessToken,
            refresh_token: refreshToken,
          }),
        })
          .then(function (response) {
            if (!response.ok) {
              return response.json().then(function (data) {
                throw new Error(data.error || "Verification failed");
              });
            }
            return response.json();
          })
          .then(function (data) {
            message.textContent = "Verifying session...";

            // Verify session was created before redirecting
            return fetch("/api/auth/session", {
              credentials: "include",
            }).then(function (sessionResponse) {
              return sessionResponse.json().then(function (sessionData) {
                if (sessionData.authenticated) {
                  title.textContent = "Success!";
                  if (type === "recovery") {
                    message.textContent = "Redirecting to password reset...";
                  } else {
                    message.textContent = "Redirecting to dashboard...";
                  }
                  setTimeout(function () {
                    window.location.href = redirectLocation;
                  }, 1000);
                } else {
                  throw new Error("Session not created. Please log in manually.");
                }
              });
            });
          })
          .catch(function (error) {
            showError(error.message);
            setTimeout(function () {
              window.location.href = "/login";
            }, 3000);
          });
      })();
      /* eslint-enable */
    </script>
  </body>
</html>
