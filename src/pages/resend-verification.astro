---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Resend Verification Email">
  <main class="flex-grow flex items-center justify-center p-8">
    <div class="w-full max-w-md">
      <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
        <div class="flex flex-col space-y-1.5 p-6">
          <h3 class="text-2xl font-semibold leading-none tracking-tight">Resend Verification Email</h3>
          <p class="text-sm text-muted-foreground">
            Didn&apos;t receive the verification email? Enter your email to resend it.
          </p>
        </div>
        <form id="resendForm">
          <div class="p-6 pt-0 grid gap-4">
            <div class="grid gap-2">
              <label
                for="email"
                class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
              >
                Email Address
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                placeholder="your.email@example.com"
              />
            </div>
            <div id="message" class="hidden"></div>
          </div>
          <div class="flex items-center p-6 pt-0">
            <button
              type="submit"
              id="submitBtn"
              class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full"
            >
              Resend Verification Email
            </button>
          </div>
        </form>
        <div class="p-6 pt-0">
          <div class="text-center text-sm">
            <a href="/login" class="underline">Back to Login</a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <style>
    #message.success {
      display: block;
      padding: 0.75rem;
      margin-top: 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid rgb(34 197 94);
      background-color: rgb(240 253 244);
      color: rgb(21 128 61);
      font-size: 0.875rem;
      line-height: 1.25rem;
    }

    #message.error {
      display: block;
      padding: 0.75rem;
      margin-top: 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid rgb(239 68 68);
      background-color: rgb(254 242 242);
      color: rgb(185 28 28);
      font-size: 0.875rem;
      line-height: 1.25rem;
    }
  </style>

  <script is:inline>
    /* eslint-disable */
    (function () {
      const form = document.getElementById("resendForm");
      const messageDiv = document.getElementById("message");
      const submitBtn = document.getElementById("submitBtn");

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(form);
        const email = formData.get("email");

        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Sending...';
        messageDiv.textContent = "";
        messageDiv.className = "hidden";

        try {
          const response = await fetch("/api/auth/resend-verification", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email: email }),
          });

          const data = await response.json();

          if (response.ok) {
            messageDiv.textContent = "Verification email sent! Please check your inbox.";
            messageDiv.className = "success";
            form.reset();
          } else {
            var errorMessage = "Error: " + data.error;
            if (data.hint) {
              errorMessage += " " + data.hint;
            }
            if (data.isRateLimit) {
              errorMessage += " TIP: Use a different email address (e.g., yourname+test@gmail.com) for testing.";
            }
            messageDiv.textContent = errorMessage;
            messageDiv.className = "error";
          }
        } catch (err) {
          messageDiv.textContent = "Failed to send email. Please try again.";
          messageDiv.className = "error";
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = "Resend Verification Email";
        }
      });
    })();
    /* eslint-enable */
  </script>
</Layout>
